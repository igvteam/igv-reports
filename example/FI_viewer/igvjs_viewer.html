<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="shortcut icon" href="https://igv.org/web/img/favicon.ico">

    <title>IGV </title>

    <link rel="stylesheet" type="text/css" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.3/themes/smoothness/jquery-ui.css"/>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <!-- Font Awesome CSS -->
    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.8/css/dataTables.bootstrap.min.css">


    <!-- IGV JS-->
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.3/jquery-ui.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.10.8/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.10.8/js/dataTables.bootstrap.min.js"></script>
    <!-- Bootstrap JS -->
    <script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>

    <script type="text/javascript" src="https://igv.org/web/test/dist/igv.min.js"></script>
</head>

<body>
    <h2>Fusion Inspector</h2>
    <div class="constainer-fluid" id="sampleHeader" style="background-color: #E7E7EF">
        <nav class="navbar navbar-default" style="background-color: #E7E7EF">
            <!--<div class="col-xs-3" id="sampleId"><p class="navbar-text"><b>Sample:</b></p></div>-->
            <div class="col-xs-3" id="FusionNameDetail"><p class="navbar-text"><b>Fusion Name:</b> Not Selected</p></div>
            <div class="col-xs-3" id="FusionJunctionDetail"><p class="navbar-text"><b>Junction Read Count:</b> Not Selected</p></div>
            <div class="col-xs-3" id="FusionSpanningDetail"><p class="navbar-text"><b>Spanning Read Count:</b> Not Selected</p></div>
        </nav>
    </div>
    <!-- End fusion details -->
    <hr>

    <!-- Start tabs -->
    <!-- Start tabs header -->
    <ul id="tabDescription" class="nav nav-tabs">
      <li role="presentation" id="tabBrowser_tab" class="active"><a href="#tabBrowser" data-toggle="tab">Browse All Fusions</a></li>
      <!-- <li role="presentation" id="igvTab"><a href="#igvBrowser" data-toggle="tab">IGV Detail</a></li> -->
    </ul>
    <!-- End tabs header -->

    <!-- Start tabs content -->
    <div class="tab-content" id="tabContent">
      <!-- Start Data Table Tab -->
         <div role="tabpanel" id="tabBrowser" class="tab-pane fade in active" data-toggle="tab">
        <!-- Start data table -->
          <div class="table-responsive">
            <table id="fusionTable" class="table table-striped table-bordered table-hover active" cell spacing="0" width="100%"></table>
          </div>
        <!-- End data table -->
      </div>
    </div>
        <script type="text/javascript">
               <!-- start igv report here -->
               "use strict;"
               var fusionInspectorState = {
                 cache : { tabs : [] },
                 browserMade : false
               }
               function makeIGVBrowser( curFusion ) {
                  console.log(curFusion);
                  var divBrowser = $("#igvBrowser")[0],
                         options = {
                             showChromosomeWidget: true,
                             showNavigation: true,
                             showKaryo: false,
                             locus: curFusion,
                             reference: {
                                 fastaURL: "finspector.fa",
                                 cytobandURL: "cytoBand.txt",
                             },
                             tracks: [
                                 {
                                     type: "sequence",
                                     order: 1
                                 },

                                 {
                                     label: "ref_annot",
                                     url: "finspector.bed",
                                     displayMode: "SQUISHED",
                                     indexed: false,
                                     order: 10,
                                     type: "annotation",
                                     format: "bed"
                                 },

                                 {
                                     label: "Junction_Spanning_View",
                                     type: "FusionJuncSpan",
                                     url: "finspector.igv.FusionJuncSpan",
                                     displayMode: "SQUISHED",
                                     indexed: false,
                                     order: 20
                                 },
 				                         {
 				                             url: "finspector.junction_reads.bam.bed.sorted.bed.gz",
 				                             label: "Junction_Reads",
 				                             displayMode: "SQUISHED",
 				                             minHeight: 30,
 				                             maxHeight: 100,
 				                             color: "cyan",
 				                             indexed: false,
 				                             order: 40,
 				                             type: "bed"
 				                         },
 				                         {
 				                             url: "finspector.junction_reads.bam",
 				                             indexURL: "finspector.junction_reads.bam.bai",
 				                             label: "Junction_Reads_Alignments",
 				                             type: "bam",
 				                             height: 100,
 				                             indexed: true,
 				                             visibilityWindow: 2000000,
 				                             order: 45
 				                          },
                           				{
                           				    url: "finspector.spanning_reads.bam.bed.sorted.bed.gz",
                           				    label: "Spanning_Reads",
                           				    displayMode: "SQUISHED",
                           				    minHeight: 30,
                           				    maxHeight: 100,
                           				    color: "purple",
                           				    indexed: false,
                           				    order: 50,
                           				    type: "bed"
                           				},
                           				{
                           				    url: "finspector.spanning_reads.bam",
                           				    indexURL: "finspector.spanning_reads.bam.bai",
                           				    type: "bam",
                           				    label: "Spanning_Reads_Alignments",
                           				    height: 100,
                           				    indexed: true,
                           				    visibilityWindow: 2000000,
                           				    order: 55
                           				}
                                ]
                              };
                         			if( "finspector.gmap_trinity_GG.fusions.gff3.bed.sorted.bed" ){
                         				options.tracks.push({
                         				    label: "Trinity_Fusion",
                         				    url: "finspector.gmap_trinity_GG.fusions.gff3.bed.sorted.bed",
                         				    displayMode: "EXPANDED",
                         				    color: "green",
                         				    indexed: false,
                         				    order: 30,
                         				    type: "bed"
                         			     });
                              }
                   fusionInspectorState.cache[ "curBrowser" ] = igv.createBrowser(divBrowser, options);
                   console.log("cached curBroswer");
                   console.log(fusionInspectorState.cache[ "curBrowser" ]);
                   fusionInspectorState.browserMade = true;
               }
               function loadIGVBrowser( curFusion, curJunctionReads, curSpanningReads, curLeftPos, curRightPos )
               {
                   // Update header no matter if the browser is being made.
                   setFusionDetails( curFusion, curJunctionReads, curSpanningReads );
                   // Do not remake browser.
                   if( ! fusionInspectorState.browserMade ){

                       // Add tab for IGV and click on tab
                       $('#tabDescription').append('<li role="presentation" id="igvTab"><a href="#igvBrowser" data-toggle="tab">IGV Detail</a></li>')
                       $('#tabContent').append('<div role="tabpanel" id="igvBrowser" class="tab-panel fade"></div>')
                       $('.nav-tabs a[href="#igvBrowser"]').tab('show');

                       // Need a wait to make sure the tabs have switched.
                       setTimeout(function(){
                           makeIGVBrowser( curFusion );
                       }, 1000);

                   } else {
                       goToFusion( curFusion, curRightPos, curLeftPos );
                   }
               }
               function goToFusion( fusionChr ){ //, fusionBreakRight, fusionBreakLeft ){
                   //var numBreakRight = parseInt( fusionBreakRight )
                   //var numBreakLeft = parseInt( fusionBreakLeft )
                   //var padLength = ( numBreakRight - numBreakLeft ) / 2
                   //fusionInspectorState.cache.curBrowser.search( fusionChr + ":" + Math.max( 0, numBreakLeft - padLength ) + "-" + ( numBreakRight + padLength ) );
                   var location = fusionChr
                   $('.nav-tabs a[href="#igvBrowser"]').tab('show');
                   setTimeout(function(){
                       fusionInspectorState.cache.curBrowser.search( location );
                   }, 1000);
               }
               function setFusionDetails( fusionName, fusionJunctReads, fusionSpanFrags ){
                   $( "#FusionNameDetail" ).html( "<p class='navbar-text'><b>Fusion Name:</b> " + fusionName + "</p>" );
                   $( "#FusionJunctionDetail" ).html( "<p class='navbar-text'><b>Junction Read Count:</b> " + fusionJunctReads + "</p>" );
                   $( "#FusionSpanningDetail" ).html( "<p class='navbar-text'><b>Spanning Read Count:</b> " + fusionSpanFrags + "</p>" );
               }
               function orderTableKeysBeginning( arrayToOrder, forcedOrder ){
                 newArray = [];
                 for( arrayElement = 0; arrayElement < arrayToOrder.length; arrayElement++ ){
                   if( !( forcedOrder.indexOf( arrayToOrder[ arrayElement ] ) >= 0 )){
                     newArray.push( arrayToOrder[ arrayElement ] );
                   }
                 }
                 return( forcedOrder.concat( newArray ));
               }
               function toTableRowHeaderElement( tableRowValue ){
                   return '<th>' + tableRowValue + '</th>';
               }
               function toTableBodyElement( fusionEntry, orderedHeaderKeys ){
                 var bodyRow = '<tr>';
                 for( var headerKeyIndex = 0; headerKeyIndex < orderedHeaderKeys.length; headerKeyIndex++ ){
                   bodyRow = bodyRow + '<td>' + fusionEntry[ orderedHeaderKeys[ headerKeyIndex ] ] + '</td>';
                 }
                 return( bodyRow + '</tr>');
               }
               function getFusionAnnotationFromRow( infoHeader, dataRow ){
                 var index = fusionInspectorState.cache.fusionKeys.indexOf( infoHeader );
                 if( index == -1 ){
                   return( None );
                 }
                 return( dataRow[ index ] );
               }
               function loadFusionDataTable( ){
                   var forcedHeaderKeyOrder = ['Fusion', 'Junction Reads', 'Spanning Fragments', 'Splice Type', 'Left Gene', 'Left Chr', 'Left Pos', 'Left Strand', 'Right Gene', 'Right Chr', 'Right Pos', "Right Strand"];

                   var fusionKeys = [];
                   for( var fusionKey in fusionInspectorState.cache.json.fusions[ 0 ] ){
                     if( fusionInspectorState.cache.json.fusions[ 0 ].hasOwnProperty( fusionKey ) ){
                       fusionKeys.push( fusionKey );
                     }
                   }
                   // fusionInspectorState.cache[ "fusionKeys" ] = orderTableKeysBeginning( forcedHeaderKeyOrder, fusionKeys );
                   // Make data table header and footer
                   var fusionTable = $('#fusionTable');
                   // var fusionHeader = fusionInspectorState.cache.fusionKeys.map( toTableRowHeaderElement );
                   // For loop instead of map
                   var fusionHeader = [];
                   for (var header = 0; header < forcedHeaderKeyOrder.length; header++){
                        fusionHeader.push( '<th>' + forcedHeaderKeyOrder[header] + '</th>');
                   }
                   // console.log(fusionHeader);
                   fusionTable.append( '<thead><tr>' + fusionHeader.join('') + '</tr></thead>' );
                   fusionTable.append( '<tfoot><tr>' + fusionHeader.join('') + '</tr></tfoot>' );

                   fusionInspectorState.cache[ "fusionKeys" ] = orderTableKeysBeginning( forcedHeaderKeyOrder, fusionKeys );

                   // Add data table body (in order of forced fusion header)
                   fusionTable.append( '<tbody>' );
                   for( var fusionIndex = 0; fusionIndex < fusionInspectorState.cache.json.fusions.length; fusionIndex++ ){
                      var fusionEntry = fusionInspectorState.cache.json.fusions[ fusionIndex ];
                      fusionTable.append( toTableBodyElement( fusionEntry, forcedHeaderKeyOrder ) );
                   }
                   fusionTable.append( '</tbody>' );

               }
               $.getJSON("finspector.fusion_inspector_web.json", function(data){
                  fusionInspectorState.cache[ "json" ] = data;
                  $(document).ready(function( ) {
                loadFusionDataTable();
                fusionInspectorState.cache.fusionTable = $('#fusionTable').DataTable({
                    'order': [[1,'desc']],
                    'scrollX': true
                });
                $('#fusionTable tbody').on('click', 'tr', function() {
                   curFusionRow = fusionInspectorState.cache.fusionTable.row( this ).data();
                   console.log(curFusionRow);
                // IGV browser has to be visible when the files are loaded.
                // If it is hidden the files load as 200 (full file) as opposed
                // to 206, whichis needed for indexed reading as igv web needs it.
                 loadIGVBrowser(
                     getFusionAnnotationFromRow( 'Fusion', curFusionRow ),
                     getFusionAnnotationFromRow( 'Junction Reads', curFusionRow ),
                     getFusionAnnotationFromRow( 'Spanning Fragments', curFusionRow ),
                     getFusionAnnotationFromRow( 'Right Pos', curFusionRow ),
                     getFusionAnnotationFromRow( 'Left Pos', curFusionRow )
                  );//loadIGVBrowser
                });//#fusionTable
                // This hooks into the event fired off by tabs being selected.
                // It forces a redraw of the tab. Because the data table is originally
                // draw in a hidden (height = 0) div, the table is misdrawn. You have to
                // Trigger a redraw when the tab is visible so the height of the data table
                // can be correctly calculated.
                // Thanks to //stackoverflow.com/questions/20705905/bootstrap-3-jquery-event-for-active-tab-change
                $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
                  $('#fusionTable').DataTable().columns.adjust().draw();
                })
                }); //Document.ready
              }) //JSON read
        </script>
</body>
</html>
